<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="chat_title">Marketplace - Chat</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="navbar-container">
    <a href="/" class="navbar-logo">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 0L24 24H0z"/>
      </svg>
      MARKETPLACE
    </a>

    <button class="icon-btn hamburger-btn" id="hamburgerBtn">â˜°</button>

    <div class="navbar-links">
      <div class="balance-badge" id="balanceBadge"><span>â‚¬0.00</span></div>
      <a href="/" class="btn-nav">View Items</a>
      <a href="/sell.html" class="btn-sell"><span>Sell Items</span></a>
      <select id="langSelect" class="category-select">
        <option value="en">English</option>
        <option value="lv">Latvian</option>
      </select>
      <button class="icon-btn" id="themeToggle">ðŸŒ“</button>
      <button class="btn-login" id="loginBtn">Login</button>
      <button class="btn-logout" id="logoutBtn" style="display:none;">Logout</button>
    </div>
  </div>
</nav>

<!-- MAIN CHAT SECTION -->
<main class="main-container messaging-section">
  <div class="chat-modern">

    <!-- Sidebar -->
    <div class="chat-sidebar">
      <div class="chat-list-header">
        <h3 data-i18n="contacts">Contacts</h3>
        <button class="btn-icon-small">+</button>
      </div>
      <div class="chat-list" id="chatList">
        <!-- Chat contacts populated via JS -->
      </div>
    </div>

    <!-- Chat main area -->
    <div class="chat-main">
      <div class="chat-header-bar">
        <div class="chat-user-info">
          <div class="chat-avatar avatar-circle" id="activeUserAvatar">A</div>
          <div>
            <div class="chat-user-name" id="activeUserName" data-i18n="select_chat">Select a chat</div>
            <div class="chat-user-status" id="activeUserStatus"></div>
          </div>
        </div>
        <div class="chat-header-actions">
          <button class="icon-btn">ðŸ’¬</button>
          <button class="icon-btn">â‹®</button>
        </div>
      </div>
      <div class="chat-messages-area" id="chatMessages">
        <!-- Messages populated via JS -->
      </div>
      <div class="chat-input-area">
        <input type="text" data-i18n-placeholder="type_message" placeholder="Type a message..." class="chat-input-field" id="messageInput">
        <button class="btn-send" id="sendBtn" data-i18n="send">Send</button>
      </div>
    </div>

  </div>
</main>

<script type="module">
import { supabase } from './js/supabase.js';
import { i18n } from './js/i18n.js';

// ============================
// Language Setup
// ============================
const langSelect = document.getElementById('langSelect');
langSelect.addEventListener('change', e => i18n.setLang(e.target.value));

// ============================
// Dark/Light Mode Toggle
// ============================
const themeToggle = document.getElementById('themeToggle');
themeToggle.addEventListener('click', () => {
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme') || 'light';
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  html.classList.remove('dark', 'light');
  html.classList.add(newTheme);
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  themeToggle.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
});

// ============================
// Hamburger Menu
// ============================
document.getElementById('hamburgerBtn').addEventListener('click', () => {
  document.querySelector('.navbar-links').classList.toggle('active');
});

// ============================
// Supabase Auth
// ============================
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const balanceBadge = document.getElementById('balanceBadge');

let currentUser = null;

async function loadUser() {
  const { data: { user } } = await supabase.auth.getUser();
  currentUser = user;
  if(user) {
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'flex';
    const { data } = await supabase.from('users').select('balance').eq('id', user.id).single();
    balanceBadge.querySelector('span').innerText = `â‚¬${parseFloat(data.balance).toFixed(2)}`;
  } else {
    loginBtn.style.display = 'flex';
    logoutBtn.style.display = 'none';
  }
}

loginBtn.addEventListener('click', async () => {
  window.location.href = 'login.html';
});

logoutBtn.addEventListener('click', async () => {
  await supabase.auth.signOut();
  window.location.href = 'index.html';
});

// ============================
// Chat Logic (Placeholder)
// ============================
const chatList = document.getElementById('chatList');
const chatMessages = document.getElementById('chatMessages');

const dummyChats = [
  { id: 1, name: 'Alice', avatar: 'A', messages: [{ sender: 'Alice', text: 'Hi there!', timestamp: '10:00' }] },
  { id: 2, name: 'Bob', avatar: 'B', messages: [{ sender: 'Bob', text: 'Hello!', timestamp: '11:00' }] }
];

function renderChats() {
  chatList.innerHTML = '';
  dummyChats.forEach(chat => {
    const div = document.createElement('div');
    div.className = 'chat-list-item';
    div.innerHTML = `
      <div class="chat-avatar avatar-circle-small">${chat.avatar}</div>
      <div class="chat-preview">
        <div class="chat-name">${chat.name}</div>
        <div class="chat-last-message">${chat.messages[0].text}</div>
      </div>
    `;
    div.addEventListener('click', () => openChat(chat));
    chatList.appendChild(div);
  });
}

function openChat(chat) {
  document.getElementById('activeUserAvatar').innerText = chat.avatar;
  document.getElementById('activeUserName').innerText = chat.name;
  chatMessages.innerHTML = '';
  chat.messages.forEach(msg => {
    const msgDiv = document.createElement('div');
    msgDiv.className = `message-group ${msg.sender === chat.name ? 'receiver' : 'sender'}`;
    msgDiv.innerHTML = `
      <div class="message-avatar avatar-circle">${msg.sender[0]}</div>
      <div class="messages-stack">
        <div class="message-bubble-modern ${msg.sender !== chat.name ? 'sender' : ''}">${msg.text}</div>
        <div class="message-timestamp ${msg.sender !== chat.name ? 'sender' : ''}">${msg.timestamp}</div>
      </div>
    `;
    chatMessages.appendChild(msgDiv);
  });
}

renderChats();
</script>

</body>
</html>
