<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="admin_title">Admin Dashboard - Marketplace</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar">
    <div class="navbar-container">
      <!-- Logo -->
      <a href="index.html" class="navbar-logo">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0L24 24H0z"/>
        </svg>
        MARKETPLACE
      </a>
  
      <!-- Hamburger for mobile -->
      <button class="icon-btn hamburger-btn" id="hamburgerBtn">â˜°</button>
  
      <!-- Links & actions -->
      <div class="navbar-links">
        <a href="balance.html" class="balance-badge" id="balanceBadge" style="display:none;"><span>â‚¬0.00</span></a>
        <a href="index.html" class="btn-nav" data-i18n="viewItems">View Items</a>
        <button class="btn-sell" id="sellBtn"><span data-i18n="sellItems">Sell Items</span></button>
 
        <!-- Pages Dropdown -->
        <div class="dropdown" id="pagesDropdown">
          <button class="dropdown-btn" data-i18n="pages">Pages</button>
          <div class="dropdown-menu">
            <a href="index.html" class="dropdown-item" data-i18n="home">Home</a>
            <a href="balance.html" class="dropdown-item" data-i18n="balance">Balance</a>
            <a href="settings.html" class="dropdown-item" data-i18n="settings">Settings</a>
            <a href="admin.html" class="dropdown-item" data-i18n="admin">Admin</a>
            <a href="chat.html" class="dropdown-item" data-i18n="chat">Chat</a>
            <a href="product.html" class="dropdown-item" data-i18n="products">Products</a>
          </div>
        </div>
 
        <!-- Language Dropdown -->
        <select id="langSelect" class="category-select">
          <option value="en">English</option>
          <option value="lv">LatvieÅ¡u</option>
        </select>
 
        <!-- Dark/Light Mode -->
        <button class="icon-btn" id="themeToggle">ðŸŒ™</button>
 
        <button class="btn-login" id="loginBtn" data-i18n="login">Login</button>
        <button class="btn-logout" id="logoutBtn" style="display:none;" data-i18n="logout">Logout</button>
      </div>
    </div>
  </nav>
  
  
  

  <main class="main-container">
    <section>
      <div class="section-header">
        <h2 class="section-title" data-i18n="dashboard">Dashboard</h2>
        <p class="section-subtitle" data-i18n="overview">Overview of marketplace activities</p>
      </div>

      <div class="features-section">

        <!-- Users Card -->
        <div class="feature-card">
          <div class="feature-icon" style="background: var(--gradient-primary);">ðŸ‘¥</div>
          <div class="feature-title" data-i18n="registered_users">Registered Users</div>
          <div class="feature-description" style="font-size: 1.25rem; font-weight: 700;">1,234</div>
        </div>

        <!-- Products Card -->
        <div class="feature-card">
          <div class="feature-icon" style="background: var(--gradient-vibrant);">ðŸ“¦</div>
          <div class="feature-title" data-i18n="total_products">Total Products</div>
          <div class="feature-description" style="font-size: 1.25rem; font-weight: 700;">567</div>
        </div>

        <!-- Transactions Card -->
        <div class="feature-card">
          <div class="feature-icon" style="background: var(--gradient-success);">ðŸ’³</div>
          <div class="feature-title" data-i18n="transactions_today">Transactions Today</div>
          <div class="feature-description" style="font-size: 1.25rem; font-weight: 700;">89</div>
        </div>

      </div>

      <section style="margin-top: 4rem;">
        <div class="section-header">
          <h3 class="section-title" data-i18n="recent_activities">Recent Activities</h3>
        </div>
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
          <thead>
            <tr style="background: var(--secondary);">
              <th style="padding: 0.75rem; border-bottom: 1px solid var(--border);" data-i18n="user">User</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid var(--border);" data-i18n="action">Action</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid var(--border);" data-i18n="date">Date</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid var(--border);" data-i18n="amount">Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding: 0.75rem;">Alice</td>
              <td style="padding: 0.75rem;" data-i18n="added_funds">Added Funds</td>
              <td style="padding: 0.75rem;">09/10/2025</td>
              <td style="padding: 0.75rem;">â‚¬50</td>
            </tr>
            <tr>
              <td style="padding: 0.75rem;">Bob</td>
              <td style="padding: 0.75rem;" data-i18n="sold_product">Sold Product</td>
              <td style="padding: 0.75rem;">09/10/2025</td>
              <td style="padding: 0.75rem;">â‚¬20</td>
            </tr>
            <tr>
              <td style="padding: 0.75rem;">Charlie</td>
              <td style="padding: 0.75rem;" data-i18n="purchased_product">Purchased Product</td>
              <td style="padding: 0.75rem;">08/10/2025</td>
              <td style="padding: 0.75rem;">â‚¬15</td>
            </tr>
          </tbody>
        </table>
      </section>

    </section>
  </main>


  <script type="module">
  import { supabase } from './js/supabase.js';
  import { i18n } from './js/i18n.js';

  // ============================
  // Admin Access Control
  // ============================
  async function checkAdminAccess() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      alert('Please log in first');
      window.location.href = 'login.html';
      return false;
    }

    // Check if user is admin
    const { data: userData, error } = await supabase
      .from('users')
      .select('role')
      .eq('id', user.id)
      .single();

    if (error || !userData || userData.role !== 'admin') {
      alert('Access denied. Admin privileges required.');
      window.location.href = 'index.html';
      return false;
    }

    return true;
  }

  // ============================
  // Language Setup
  // ============================
  document.getElementById('langSelect').addEventListener('change', e => {
    i18n.setLang(e.target.value);
  });

  // ============================
  // Dark/Light Mode Toggle
  // ============================
  document.getElementById('themeToggle').addEventListener('click', () => {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    html.classList.remove('dark', 'light');
    html.classList.add(newTheme);
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    document.getElementById('themeToggle').textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
  });

  // ============================
  // Hamburger Mobile Menu
  // ============================
  document.getElementById('hamburgerBtn').addEventListener('click', () => {
    document.querySelector('.navbar-links').classList.toggle('active');
  });

  // ============================
  // Supabase Auth & Admin Dashboard
  // ============================
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const balanceBadge = document.getElementById('balanceBadge');
  const sellBtn = document.getElementById('sellBtn');

  async function loadUser() {
    const { data: { user } } = await supabase.auth.getUser();
    if(user) {
      // Check admin access
      const isAdmin = await checkAdminAccess();
      if (!isAdmin) return;

      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'flex';
      const { data } = await supabase.from('users').select('balance').eq('id', user.id).single();
      balanceBadge.querySelector('span').innerText = `â‚¬${parseFloat(data.balance).toFixed(2)}`;

      // Load admin dashboard data
      loadDashboardStats();
      loadRecentActivities();
    } else {
      loginBtn.style.display = 'flex';
      logoutBtn.style.display = 'none';
    }
  }

  // Load dashboard statistics
  async function loadDashboardStats() {
    try {
      // Get user count
      const { count: userCount, error: userError } = await supabase
        .from('users')
        .select('*', { count: 'exact', head: true });

      // Get product count
      const { count: productCount, error: productError } = await supabase
        .from('products')
        .select('*', { count: 'exact', head: true });

      // Get today's transactions
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const { count: transactionCount, error: transactionError } = await supabase
        .from('user_transactions')
        .select('*', { count: 'exact', head: true })
        .gte('created_at', today.toISOString());

      // Update dashboard cards
      if (!userError) {
        document.querySelector('[data-i18n="registered_users"]').nextElementSibling.textContent = userCount || 0;
      }
      if (!productError) {
        document.querySelector('[data-i18n="total_products"]').nextElementSibling.textContent = productCount || 0;
      }
      if (!transactionError) {
        document.querySelector('[data-i18n="transactions_today"]').nextElementSibling.textContent = transactionCount || 0;
      }
    } catch (error) {
      console.error('Error loading dashboard stats:', error);
    }
  }

  // Load recent activities
  async function loadRecentActivities() {
    try {
      const { data: transactions, error } = await supabase
        .from('user_transactions')
        .select(`
          *,
          users(username)
        `)
        .order('created_at', { ascending: false })
        .limit(10);

      if (error) throw error;

      const tbody = document.querySelector('tbody');
      tbody.innerHTML = '';

      transactions.forEach(tx => {
        const row = document.createElement('tr');
        const amount = Math.abs(parseFloat(tx.amount || 0));

        row.innerHTML = `
          <td style="padding: 0.75rem;">${tx.users?.username || 'Unknown'}</td>
          <td style="padding: 0.75rem;">${getActivityDescription(tx.transaction_type)}</td>
          <td style="padding: 0.75rem;">${new Date(tx.created_at).toLocaleDateString()}</td>
          <td style="padding: 0.75rem;">â‚¬${amount.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
      });
    } catch (error) {
      console.error('Error loading recent activities:', error);
    }
  }

  function getActivityDescription(type) {
    const descriptions = {
      'deposit': 'Added Funds',
      'purchase': 'Purchased Product',
      'sale': 'Sold Product',
      'listing_fee': 'Listing Fee',
      'reserve_fee': 'Reserve Fee',
      'escrow_hold': 'Purchase (Escrow)',
      'escrow_pending': 'Sale (Escrow)',
      'escrow_released': 'Escrow Released'
    };
    return descriptions[type] || type;
  }

  loginBtn.addEventListener('click', async () => {
    window.location.href = 'login.html';
  });

  logoutBtn.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = 'index.html';
  });

  if (sellBtn) {
    sellBtn.addEventListener('click', () => {
      window.location.href = 'sell.html';
    });
  }

  // Initialize admin dashboard
  loadUser();
  </script>
  
</body>
</html>
